﻿@using Asistant.Areas.Customer.Models
@model CreateRequestViewModel
@{
    Layout = "/Views/Shared/_Layout.cshtml";
    ViewData["Title"] = "ثبت سفارش";
}
@section Styles {
    <link rel="stylesheet" href="~/css/requestform.css" />

    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/persian-datepicker.min.css" />
    <style>
        .persian-datepicker-container {
            font-family: 'Vazir', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            direction: rtl;
        }

        .persian-datepicker-rtl .picker-footer {
            text-align: left;
        }

        .input-validation-error {
            border-color: #dc3545 !important;
        }
    </style>



}

<div class="container">
    <h2>ثبت سفارش جدید</h2>
    @if (ViewBag.Error != null)
    {
        <div class="alert alert-danger">
            @ViewBag.Error
        </div>
    }
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success">
            @TempData["Success"]
        </div>
    }

    <div class="mb-3">

        @if (!string.IsNullOrEmpty(Model.HomeService.ImagePath))
        {
            <img src="@Url.Content(Model.HomeService.ImagePath))"
                 alt="@Model.HomeService.Name"
                 class="img-thumbnail"
                 style="max-width:150px;" />
        }

        else
        {

            <p>عکسی ثبت نشده است</p>
        }
    </div>

    <table class="table table-striped table-hover text-center">
        <thead class="table-light">
            <tr>
                <th>نام سرویس</th>
                <th>قیمت پایه سرویس</th>
                <th>دسته بندی سرویس</th>
                <th>توضیحات</th>


            </tr>
        </thead>
        <tbody>

            <tr>
                <td>@Model.HomeService.Name</td>
                <td>@Model.HomeService.BasePrice.ToString("N0") ریال</td>
                <td>@Model.HomeService.CategoryName</td>
                <td>@Model.HomeService.Description</td>


            </tr>

        </tbody>
    </table>

    <form asp-area="Customer" asp-controller="Request" asp-action="CheckoutRequest" method="post" enctype="multipart/form-data">
        <div asp-validation-summary="All" class="text-danger"></div>
        <input type="hidden" asp-for="@Model.HomeServiceId" />

        <label asp-for="@Model.Title">عنوان</label>
        <input asp-for="@Model.Title" type="text" id="title">

        <label asp-for="@Model.Description">توضیحات</label>
        <textarea id="description" asp-for="@Model.Description"></textarea>

        <label asp-for="@Model.Images">تصاویر</label>
        <input asp-for="@Model.Images"
               type="file"
               accept="image/*"
               multiple
               class="form-control"
               id="imageInput">

        <div id="imagePreview" class="row mt-3"></div>



        <label asp-for="@Model.PersianDate">تاریخی که مایلید این سرویس را دریافت کنید وارد کنید</label>
        <input type="text" id="PersianDate" asp-for="@Model.PersianDate" class="form-control" autocomplete="off" />

        <button type="submit">ثبت سفارش</button>
    </form>
</div>
@section Scripts {
    <script src="~/lib/jquery/jquery.min.js"></script>

    <script>
        $(document).ready(function () {
            $("#PersianDate").persianDatepicker({
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: false,
                minDate: new persianDate(), 
                calendar: {
                    persian: {
                        locale: 'fa'
                    }
                }
            });
        });
    </script>



    <script>
        let selectedFiles = [];

        const input = document.getElementById('imageInput');
        const preview = document.getElementById('imagePreview');

        input.addEventListener('change', function () {
            const files = Array.from(this.files);

                   if ((selectedFiles.length + files.length) > 5) {
            alert('حداکثر ۵ تصویر مجاز است');
            this.value = '';
            return;

        }
            files.forEach(file => {

                if (!file.type.startsWith('image/')) return;

                if (file.size > 2 * 1024 * 1024) {
                    alert(`حجم فایل ${file.name} بیشتر از ۲ مگابایت است`);
                    return;
                }

                selectedFiles.push(file);
            });

            renderPreview();
            input.value = '';
        });

        function renderPreview() {
            preview.innerHTML = '';

            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 mb-3';

                    col.innerHTML = `
                        <div class="card">
                            <img src="${e.target.result}" class="card-img-top" style="height:150px;object-fit:cover;">
                            <div class="card-body p-2 text-center">
                                <small>${file.name}</small>
                                <button type="button" class="btn btn-sm btn-danger remove-btn" data-index="${index}">حذف</button>
                            </div>
                        </div>
                    `;

                    preview.appendChild(col);


                    col.querySelector('.remove-btn').addEventListener('click', function () {
                        const idx = parseInt(this.dataset.index);
                        selectedFiles.splice(idx, 1);
                        renderPreview();
                    });
                };
                reader.readAsDataURL(file);
            });
        }


        document.querySelector('form').addEventListener('submit', function (e) {

        });
    </script>


}